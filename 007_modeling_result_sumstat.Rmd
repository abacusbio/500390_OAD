---
title: "Post modeling analysis"
author: "Luna Zhang"
date: "`r Sys.Date()`"
output: #> rmarkdown::html_vignette
  html_document:
    toc: true
    toc_float: false
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = F, warning = F, message = F,
                      root.dir = "e:/500390_OAD/output/modeling/"
)
```

Modelling of survival on effects.

```{r, include =FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(kableExtra)
# library(plm)

source("utils.R")


outputDir <- "c:/Users/lzhang/Documents/GitHub/500390_OAD/output/" # "z:/Luna/500390_OAD/explore/"
# rawfileDir <- "e:/OAD Dairy Data/2022021110_EBVs/"
fileDir <- "e:/500390_OAD/output/modeling/" # copy to "z:/Luna/500390_OAD/output/" later

# if(!exists(outputDir)) dir.create(outputDir)
```

```{r load, cache=TRUE, cache.lazy=FALSE, cache.extra=tools::md5sum("e:/500390_OAD/output/modeling/df_downsample.RData")}
df_downsample <- readRDS(paste0(fileDir, "df_downsample.RData"))

```

# Sampled data summary statistics
```{r}
cat("Downsampled dataset has", nrow(df_downsample), "events,",
    unique(df_downsample$AnimalDurableCode) %>% length(), "cows, and",
    unique(df_downsample$HerdDurableKey) %>% length(), "herds.")

group_by(df_downsample, herd_milk_type, HerdDurableKey) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% group_by(herd_milk_type) %>% tally() %>% 
  mutate(prop = n/sum(n)) %>% 
  knitr::kable(align = "l", 
               caption = "N herds by herd Regime type", digits = 2) %>% 
  kable_styling(full_width = T)

group_by(df_downsample, herd_milk_type, new_milk_type) %>% 
 # summarise(count = n()) %>% 
  #ungroup() %>% group_by(herd_milk_type, new_milk_type) %>% 
  tally() %>% 
  mutate(prop = n/sum(n)) %>% 
  knitr::kable(align = "l",
               caption = "N animals by milking type", digits = 2,
               format.args = list(big.mark=",")) %>% 
  kable_styling(full_width = T)
```

# EBV and milk_type interaction model

e.g. `glm(formula = s12 ~ cg + Trait + milk_type + Trait*milk_type, family = gaussian(link = "identity"),  ...)`  
Only look at OAD and TAD. Each model takes up to 10 min to run.  
The objective is to see if the trait EBV has an effect and if its effects are
different in different milking types (OAD and TAD).

```{r interaction shapeshift}
coef_glms <- lapply(dir(fileDir, "coef_glm_x_s"), function(i) {
  return(read.csv(paste0(fileDir, i), header = T) %>%
           rename(Trait = X) %>%
           mutate(sign = ifelse(is.na(sign), "", 
                                ifelse(sign==".", "+", sign)),
                  predictor = Trait))
})

anova_glms <- lapply(dir(fileDir, "anova_glm_x_s"), function(i) {
  return(read.csv(paste0(fileDir, i), header = T) %>% 
           rename(Trait = X) %>% 
           mutate(sign = ifelse(is.na(sign), "", 
                                ifelse(sign==".", "+", sign)),
                  predictor = Trait))
})

df_coef_glms <- do.call(rbind, coef_glms)
df_anova_glms <- do.call(rbind, anova_glms)

# change Trait
idx <- grep("^EBV", df_anova_glms$predictor)
idx1 <- grep("NULL", df_anova_glms$predictor)
d <- diff(idx1) %>% unique()
for(i in seq(idx1)) {
  df_anova_glms$Trait[idx1[i]:(idx1[i]+d-1)] <- df_anova_glms$predictor[idx[i]]
}

# convert anova output
print_anova <- filter(df_anova_glms, !grepl("NULL|cg|type[0-9]*$", predictor)) %>% 
  mutate(R2 = Deviance/(Resid..Dev+Deviance)) %>% 
  select(Trait, predictor, R2, sign, survival) %>% 
  pivot_wider(id_cols = matches("Trait|predi"), 
              names_from = survival, values_from = c(R2, sign), 
              names_glue = "{survival}_{.value}") %>% 
  select(Trait, predictor, matches("s12"), matches("s23"), 
         matches("s34"), matches("s45")) %>% 
  mutate(across(where(is.numeric), ~ifelse(.x==round(.x),
    round(.x), formatC(.x, digits = 2, format = "fg"))))

# change Trait
idx <- grep("^new", df_coef_glms$predictor)
d <- diff(idx) %>% unique()
for(i in seq(idx)) {
  df_coef_glms$Trait[(idx[i]-d+1):idx[i]] <- df_coef_glms$predictor[idx[i]-d+1]
}
 
# convert coef output
print_coef <- df_coef_glms %>% 
  select(Trait, predictor, Estimate, sign, survival) %>% 
  pivot_wider(id_cols = matches("Trait|predi"), 
              names_from = survival, values_from = c(Estimate, sign), 
              names_glue = "{survival}_{.value}") %>% 
  select(Trait, predictor, matches("s12"), matches("s23"), 
         matches("s34"), matches("s45")) %>% 
  mutate(across(where(is.numeric), ~ifelse(.x==round(.x),
    round(.x), formatC(.x, digits = 2, format = "fg"))))
```

## Coefficients

The reference (intercept) is OAD + trait\*OAD, thus only the coefficients of 
Trait and Trait\*TAD are used to test against the reference. 

```{r}
knitr::kable(print_coef, align = "l",
             format.args = list(big.mark = ","), 
             caption = "Linear regression model coeficient statistics" )%>% 
  kable_styling(fixed_thead = T)

# write.csv(print_coef, paste0(fileDir, "coef_glm_x_all.csv"), 
          # row.names = F, quote = F)
write.csv(print_coef, paste0(fileDir, "coef_glm_x_all.csv"), 
          row.names = F, quote = F)
```
*Foot notes for the signs of P-values:*  
\*\*\*: $p<0.001$  
\*\*: $0.001 \le p<0.01$  
\*: $0.01 \le p<0.05$  
.: $0.05 \le p<0.1$  

## Model powers

This is an ANOVA and Chi-sq test of the model predictors, to show if the trait
and interaction terms are significantly different.

Because new_milk_type is always insignificant in all models, the result isn't
shown in the table.

```{r}
knitr::kable(print_anova, align = "l",
             format.args = list(big.mark = ","), 
             caption = "Linear regression model statistics (ANOVA+Chi-sq)" )%>% 
  kable_styling(fixed_thead = T)

# write.csv(print_coef, paste0(fileDir, "coef_glm_x_all.csv"), 
          # row.names = F, quote = F)
write.csv(print_anova, paste0(fileDir, "anova_glm_x_all.csv"), 
          row.names = F, quote = F)
```


# EBV only model within each survival and milk_type levels

e.g. `glm(formula = s12 ~ cg + Trait, family = gaussian(link = "identity"),  ...)`

```{r shapeshift}

coef_glms <- lapply(dir(fileDir, "coef_glm_s"), function(i) {
  return(read.csv(paste0(fileDir, i), header = T) %>% 
           rename(Trait = X) %>% 
          mutate(sign = ifelse(is.na(sign), "", 
                                ifelse(sign==".", "+", sign)),
                  predictor = Trait))
})

anova_glms <- lapply(dir(fileDir, "anova_glm_s"), function(i) {
  return(read.csv(paste0(fileDir, i), header = T) %>% 
           rename(Trait = X) %>% 
           mutate(sign = ifelse(is.na(sign), "", 
                                ifelse(sign==".", "+", sign)),
                  predictor = Trait))
})

df_coef_glms <- do.call(rbind, coef_glms)
df_anova_glms <- do.call(rbind, anova_glms)

if(grepl("Chi", names(df_anova_glms)) %>% sum()>0) {
  names(df_anova_glms)[5] <- "Resid..Dev"
  names(df_anova_glms)[6] <- "p-value"
  df_anova_glms$sign <- ifelse(df_anova_glms$`p-value`<0.001, "***", 
                           ifelse(df_anova_glms$`p-value`<0.01, "**",
                                  ifelse(df_anova_glms$`p-value`<0.05, "*",
                                         ifelse(df_anova_glms$`p-value`<0.1, "+",""))))
  
  df_anova_glms <- df_anova_glms %>% 
    select(Trait, Df, Deviance, Resid..Df, Resid..Dev, `p-value`, sign, milk_type,
           survival)
  
} 
  
# df_anova_glms <- df_anova_glms %>% 
#            mutate(sign = ifelse(is.na(sign), "", sign))

# convert anova output
print_anova <- filter(df_anova_glms, grepl("EBV", Trait)) %>% 
  mutate(R2 = Deviance/(Resid..Dev+Deviance)) %>% 
  select(Trait, R2, `p-value`, sign, milk_type, survival) %>% 
  pivot_wider(id_cols = matches("survival|Trait"), 
              names_from = milk_type, values_from = c(R2, sign), 
              names_glue = "{milk_type}_{.value}") %>% 
  select(survival, Trait, matches("OAD"), matches("TAD"), 
         matches("s12"), matches("s23"), matches("s34"), matches("s45")) %>% 
  mutate(across(where(is.numeric), ~ifelse(.x==round(.x),
    round(.x),formatC(.x, digits = 2, format = "fg"))))

print_coef <- select(df_coef_glms, -matches("value")) %>% 
  pivot_wider(names_from = milk_type, values_from = c(Estimate, Std..Error, sign),
               names_glue = "{milk_type}_{.value}") %>% 
  select(survival, Trait, matches("OAD"), matches("TAD"), 
         matches("s12"), matches("s23"), matches("s34"), matches("s45")) %>% 
  mutate(across(where(is.numeric), ~ifelse(.x==round(.x),
    round(.x),formatC(.x, digits = 2, format = "fg"))
    ))
```

## OAD only, Coefficients for all traits' EBVs

```{r}
select(print_coef, survival, Trait, matches("OAD")) %>% 
  knitr::kable(format.args = list(big.mark=","), align = "l",
             caption = "Linear regression coefficient statistics") %>% 
  kable_styling(fixed_thead = T)
```

## All milking type, coefficients for all trait EBVs

```{r}
knitr::kable(print_coef, align = "l",
             format.args = list(big.mark=","),
             caption = "Linear regression coefficient statistics") %>% 
  kable_styling(fixed_thead = T)
```

## Model powers

```{r}
knitr::kable(print_anova, digits = 3, align = "l",
             caption = "Linear regression model statistics (ANOVA+Chi-sq)" )%>% 
  kable_styling(fixed_thead = T)

write.csv(print_coef, paste0(fileDir, "coef_glm_all.csv"), row.names = F, quote = F)
write.csv(print_anova, paste0(fileDir, "anova_glm_all.csv"), row.names = F, quote = F)
```


```{r, eval = F}
rmarkdown::render(output_dir = outputDir, 
                  input = rstudioapi::getSourceEditorContext()$path)
```